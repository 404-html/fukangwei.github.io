<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="暴徒">
<meta property="og:url" content="http://fukangwei.gitee.io/page/71/index.html">
<meta property="og:site_name" content="暴徒">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="暴徒">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '561O3H1PZB',
      apiKey: '7631d3cf19ac49bd39ada7163ec937a7',
      indexName: 'fuxinzi',
      hits: "",
      labels: ""
    }
  };
</script>



  <link rel="canonical" href="http://fukangwei.gitee.io/page/71/">





  <title>暴徒</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">暴徒</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos互斥信号量/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos互斥信号量/" itemprop="url">ucos互斥信号量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T13:42:29+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;在<code>ucos</code>信号量使用过程中，经常会用到二值信号量。而在二值信号量中，最常用的情况就是互斥信号量。互斥信号是本身是一种二进制信号，具有超出<code>ucos</code>提供的一般信号机制的特性。由于其特殊性，<code>ucos</code>的作者组织了一套关于互斥信号量管理的函数。互斥信号量具有以下特点：解决优先级反转问题、实现对资源的独占式访问(二值信号量)。<br>&emsp;&emsp;在应用程序中，使用互斥信号是为了减少优先级翻转问题。当一个高优先级的任务需要的资源被一个低优先级的任务使用时，就会发生优先级翻转。为了解决该问题，内核可以提升低优先级任务的优先级，先于高优先级的任务运行，释放占用的资源。<br>&emsp;&emsp;例如有三个任务可以使用共同的资源，为了访问这个资源，每个任务必须在互斥信号<code>ResourceMutex上</code>等待(<code>pend</code>)。任务<code>1</code>有最高优先级<code>10</code>，任务<code>2</code>优先级为<code>15</code>，任务<code>3</code>优先级为<code>20</code>。一个没有使用的正好在最高优先级之上的优先级<code>9</code>用来作为优先级继承优先级。如main所示，代码<code>(1)</code>中进行<code>ucos</code>初始化，并通过调用<code>OSMutexCreate</code>在代码<code>(2)</code>中创建了一个互斥信号。需要注意的是，<code>OSMutexCreate</code>函数使用<code>PIP</code>作为参数。然后在代码<code>(3)</code>中创建三个任务，在代码<code>(4)</code>中启动<code>ucos</code>。<br>&emsp;&emsp;假设任务运行了一段时间，在某个时间点，任务<code>3</code>最先访问了共同的资源，并得到了互斥信号。任务<code>3</code>运行了一段时间后被任务<code>1</code>抢占，任务<code>1</code>需要使用这个资源，并通过调用<code>OSMutexPend</code>企图获得互斥信号。这种情况下，<code>OSMutexPend</code>会发现一个高优先级的任务需要这个资源，就会把任务<code>3</code>的优先级提高到<code>9</code>，同时强迫进行上下文切换退回到任务<code>3</code>执行。任务<code>3</code>可以继续执行，然后释放占用的共同资源。任务<code>3</code>通过调用<code>OSMutexPost</code>释放占用的<code>mutex</code>信号，<code>OSMutexPost</code>会发现<code>mutex</code>被一个优先级提升的低优先级任务占有，就会把任务<code>3</code>的优先级返回到<code>20</code>。然后把资源释放给任务<code>1</code>使用，执行上下文切换到任务<code>1</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">OS_EVENT *ResourceMutex;</span><br><span class="line">OS_STK TaskPrio10Stk[<span class="number">1000</span>];</span><br><span class="line">OS_STK TaskPrio15Stk[<span class="number">1000</span>];</span><br><span class="line">OS_STK TaskPrio20Stk[<span class="number">1000</span>];</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    INT8U err;</span><br><span class="line">    OSInit(); <span class="comment">/*(1)*/</span></span><br><span class="line">    <span class="comment">/* 应用程序初始化 */</span></span><br><span class="line">    ResourceMutex = OSMutexCreate ( <span class="number">9</span>, &amp;err ); <span class="comment">/* (2) */</span></span><br><span class="line">    OSTaskCreate ( TaskPrio10, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;TaskPrio10Stk[<span class="number">999</span>], <span class="number">10</span> ); <span class="comment">/* (3) */</span></span><br><span class="line">    OSTaskCreate ( TaskPrio15, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;TaskPrio15Stk[<span class="number">999</span>], <span class="number">15</span> );</span><br><span class="line">    OSTaskCreate ( TaskPrio20, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;TaskPrio20Stk[<span class="number">999</span>], <span class="number">20</span> );</span><br><span class="line">    <span class="comment">/* Application Initialization */</span></span><br><span class="line">    OSStart(); <span class="comment">/* (4) */</span></span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TaskPrio10</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line">    INT8U err;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">        OSMutexPend ( ResourceMutex, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="comment">/* 访问共享资源 */</span></span><br><span class="line">        OSMutexPost ( ResourceMutex );</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TaskPrio15</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line">    INT8U err;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">        OSMutexPend ( ResourceMutex, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="comment">/* 访问共享资源 */</span></span><br><span class="line">        OSMutexPost ( ResourceMutex );</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TaskPrio20</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line">    INT8U err;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">        OSMutexPend ( ResourceMutex, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="comment">/* 访问共享资源 */</span></span><br><span class="line">        OSMutexPost ( ResourceMutex );</span><br><span class="line">        <span class="comment">/* 应用程序代码 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;<code>ucos</code>互斥信号包含三个元素，<code>flag</code>表示当前<code>mutex</code>是否能够获得(<code>0</code>或<code>1</code>)；<code>priority</code>表示使用这个<code>mutex</code>的任务，以防止一个高优先级的任务需要访问<code>mutex</code>；还包括一个等待这个<code>mutex</code>的任务列表。为了启动<code>ucos</code>的<code>mutex</code>服务，应该在<code>OS_CFG.H</code>中设置<code>OS_MUTEX_EN</code>为<code>1</code>。在使用一个互斥信号之前应该创建它，创建一个<code>mutex</code>信号通过调用<code>OSMutexCreate</code>完成，<code>mutex</code>的初始值总是设置为<code>1</code>，表示资源可以获得。<br>&emsp;&emsp;<code>ucos</code>提供了六种访问互斥信号量的操作：<code>OSMutexCreate</code>、<code>OSMutexDel</code>、<code>OSMutexPend</code>、<code>OSMutexPost</code>、<code>OSMutexAccept</code>和<code>OSMutexQuery</code>，这些函数展示了任务和互斥信号量的关系。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos系统使用原则/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos系统使用原则/" itemprop="url">ucos系统使用原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T12:47:46+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>任务的独立性表现为逻辑上的<code>平等性</code>和信息传输的<code>异步性</code>。</li>
<li>所有任务在逻辑上是平等的。</li>
<li>可剥夺型内核意味着<code>已经就绪的高优先级任务可以剥夺另一个正在运行的低优先级任务的运行权而进入运行状态</code>。</li>
<li>输入/输出设备与<code>CPU</code>速度的差别是并发运行的前提和基础，也是一个通常都满足的事实。以<code>CPU</code>为中心，将与各种输入/输出设备(或端口)相关的功能分别划分为独立的任务。</li>
<li><code>关键性</code>是指某种功能在应用系统中的重要性，如果这种功能不能正常实现，则将造成重大影响，甚至引发灾难性的后果。包含关键功能的任务称为<code>关键任务</code>，关键任务必须得到运行机会，即使遗漏执行一次也不行。对于关键任务，必须尽可能和其他功能剥离，独立成为一个任务，通过通信方式在触发其他任务，完成后续操作。</li>
<li><code>紧迫性</code>是指某种功能必须在规定的时间内得到运行权(及时运行)，并在规定的时间前执行完毕(按时完成)，可见这类功能有严格的实时性要求。大多数紧迫任务是由异步事件触发的，这些异步事件一般能够引发某种中断。在这种情况下，将紧迫任务安排在相应的<code>ISR</code>中是最有效的方法。如果紧迫任务不能安排在<code>ISR</code>中，那么为它安排在尽可能高的优先级是解决<code>及时性</code>有效方法。要达到按时完成的目的，必须使紧迫任务需要的执行时间尽可能短。办法是对紧迫任务进行瘦身，尽可能剥离不太紧迫的操作，只剩下必须立刻做的操作，将被剥离的不太紧迫的操作另外封装为一个任务。</li>
<li>用户应用程序中消耗时机最多的是各种数据处理程序单元，这种单元通常不止一个，它们分别为不同的功能服务。应该将这些单元划分出来，分别包装成为不同的任务。由于这类任务需要消耗较多时机，它们的优先级必须安排得比较低，只使用其他任务剩余的时机来进行数据处理。</li>
<li>将关系密切的若干个功能组合成为一个任务，达到功能聚合的效果。</li>
<li>如果若干功能由相同的事件触发，则可以将这些功能组合成为一个任务，从而免除将事件分发给多个任务的工作量。符合本类任务的触发条件通常是内部事件。</li>
<li>将周期相同的功能组合在一起封装为一个任务，就可以避免一个时间事件触发几个任务，省去事件分发操作和它们之间的通信。</li>
<li>将若干按固定顺序执行的功能组合为一个任务，从而免除同步接力通信的麻烦。</li>
<li>在用户任务函数中，必须包含至少一次对操作系统服务函数的调用，否则比其优先级低的任务将无法得到运行机会，这是用户任务函数与普通函数的明显区别。</li>
<li>采用<code>创建任务</code>的方式来启动任务，可以省去用通信手段触发任务的麻烦，还可以通过<code>(* pdata)</code>来传递原始参数，使得每次启动任务时可以有不同的工作状态。</li>
<li>适合采用<code>创建任务</code>的方式来启动的任务，通常是孤立任务，它们不和其他任务进行通信(<code>ISR</code>除外)，只使用共享资源来获取信息和输出信息。</li>
<li>事件触发执行的任务：此类任务在创建后，虽然可以获得运行权，但任务实体代码的执行需要等待某种事件的发生。相关事件发生一次，该任务实体代码就执行一次。</li>
<li>当某个信息的生产者和消费者都是同一个任务(和其他任务无关)时，保存这个信息的数据结构应该在该任务函数的内部定义；当某个信息的生产者和消费者不是同一个任务(包括<code>ISR</code>)时，保存这个信息的数据结构应该在任务函数的外部定义，使它成为共享资源，如全局变量。</li>
<li>将公共函数设计为<code>可重入函数</code>的关键是不使用全局资源；如果<code>可重入函数</code>调用了其它函数在，则这些被调用的函数也必须是<code>可重入函数</code>。</li>
<li>一个任务的代码设计过程是从上到下的过程，先分析系统总体任务关联图，明确每个任务在系统整体中的位置和角色，再将任务一个一个地进行详细关联分析，然后画出任务的程序流程图，最后按程序流程图编写程序代码。</li>
<li>一个任务的运行过程需要和其它任务的运行配合，才能得到预定的效果。任务之间的这种动作配合和协调关系称为<code>行为同步</code>。</li>
<li><code>二值信号量</code>的使用范围是：被控制方总能及时响应控制方发出的信号，完成相应处理任务，并在下一次信号来到之前进入等待状态。</li>
<li><code>计数信号量</code>的使用范围是：被控制方不能保证在下次信号来到之前处理完本次控制方发出的信号，但总体上可以响应所有信号。</li>
<li><code>事件标志组</code>可以实现多个任务(包括<code>ISR</code>)协同控制一个任务，当各个相关任务(包括<code>ISR</code>)先后发出自己的信号后(使事件标志组对应标志有效)，预定的逻辑运算有效，触发被控制的任务(使其进入就绪状态)。</li>
<li>由于<code>消息邮箱</code>只能存放一条消息，在使用消息邮箱进行同步控制时，必须满足一个前提：任何时候消息的生产速度都比消息的消费速度慢，即被控制任务总是在等待消息，这和二值信号量类似。</li>
<li><code>消息队列</code>可以存放多个消息能够有效解决消息的堆积问题。和计数信号量的情况类似，消息队列的使用仍需要满足一个条件：消息的平均生产时间比消息的平均消费时间长(即生产速度慢，消费速度快)；否则，再长的消息队列也会溢出。</li>
<li>可以通过协调生产者和消费者的关系来建立一个产销平衡的理想状态。通信的双方相互制约，生产者通过提供消息来同步消费者，消费者通过回复消息来同步生产者，即生产者必须得到消费者的回复后才能进行下一个消息的生产。这种运行方式称为<code>双向同步</code>，它可以达到产销平衡的理想状态。双向同步主要功能为确认每次通信均成功，没有遗漏。</li>
<li>事件标志组的<code>逻辑与</code>控制功能具有安全控制的特点，它可用来保障一个重要任务必须在万事俱备的前提下才执行；<code>逻辑或</code>控制功能具有补充控制的特点，它可用来在一个基本控制方式下增加若干补充控制，以满足某些特殊情况的需要。</li>
<li>多个任务相互同步可以将若干相关任务的运行频度保持一致(每一轮运行的先后、快慢可以动态变化)。<code>多任务互相同步</code>保证在任何情况下各个任务的有效执行次数都相同，而且等于运行速度最低的任务执行次数。这种同步方式具有团队作战的特点，它可以在一个需要多任务配合进行的循环作业中。</li>
<li>任务对共享资源进行访问的代码段落成为关键段落，各个任务访问同一共享资源的关键段落必须互斥，才能保障共享资源信息的可靠性和完整性。这种使得不同任务访问共享资源时能够确保共享资源信息可靠和完整的措施称为<code>资源同步</code>。</li>
<li>当参与访问共享资源的并发程序单元包含<code>ISR</code>时，任务级程序单元只能用<code>关中断</code>的措施来访问共享资源。关中断的优点是简单，缺点是影响任务的实时性。为了减轻对系统实时性的不利影响，访问共享资源的代码必须尽量简短，绝对不允许在关键代码段落中包含有可能使自己挂起的系统服务函数，否则将使系统死机。关中断常用于对全局变量和小规模全局数据结构的访问。</li>
<li><code>关调度</code>的缺点是：使与该共享资源无关的任务受到牵连，即使它们的优先级足够高并被<code>ISR</code>触发到就绪状态也无法运行，而这类与<code>ISR</code>关联的任务通常有比较高的实时性要求。因此，尽可能不使用关调度的方式。</li>
<li><code>互斥信号</code>量具有处理优先级反转的功能，特别适合对共享资源的互斥访问。使用互斥信号量来进行共享资源访问对系统实时性影响最小。</li>
<li><code>全局变量</code>(包括全局数组和全局结构体)可以充当一种共享资源，用来在任务之间传输数据。全局变量虽然可以实现数据传输，但不能实现行为同步。在没有行为同步要求的前提下，当数据的传输量不大时，采用全局变量并搭配关中断的资源同步措施是一种经济有效的方法。</li>
<li><code>消息邮箱</code>就是具有行为同步功能的通信手段，当双方的执行频度相同时，<code>消息邮箱</code>是合适的通信工具。如果用<code>ISR</code>的局部变量来保存消息，接收消息的一方就不能获得真正的消息。原因是接收消息的一方在获得消息指针时<code>ISR</code>已经结束，它的局部变量也一同消失。<code>ISR</code>可靠发送消息的方法有三种：将消息保存在全局变量中；将消息保存在<code>ISR</code>的静态局部变量中；将消息的内容冒充指针进行发送。冒充指针进行发送的方法如下所示：对发送方，如果消息指针的格式改为<code>(void *)Temp</code>，则将变量<code>Temp</code>的数值(而不是地址)作为消息指针执行传输；对接收方，当指针消息为短消息时，不再把它当做指针看待，而应该通过强制类型转换(<code>u32</code>)，直接当做一个<code>4</code>字节的整数使用。</li>
<li><code>消息队列</code>适用于以下场合：通信双方至少有一方没有稳定的执行周期；通信双方的执行周期不同。要使用消息队列，需要准备两个数组：一个是消息指针数组，供实时操作系统用来排队使用；另一个是消息内容数组，供用户使用。使用消息队列的最简单方法是利用实时操作系统的动态内存管理功能来管理消息内容数组。如果发往消息队列的消息全都是内容比较简短(不超过<code>4</code>字节)的短消息，就可以省略消息内容数组，这给我们带来不少方便。</li>
<li>时间管理函数只能用在对时间精度要求不高的场合，或者时间间隔较长的场合。</li>
<li>查询过程是一个无限循环的过程，只有当希望的状态出现以后才能退出这个无限循环，这种情况在实时操作系统中是不允许的，它将剥夺低优先级任务的运行机会。解决这个问题的办法是<code>用定时查询代替连续查询</code>，即在查询的过程中插入系统延时函数，不断地将<code>CPU</code>交出来，供其他任务使用。</li>
<li>调用<code>有超时限制的等待信号量(或消息)</code>的系统函数可以实现双重目的：在没有按时获取信号量(或消息)时，其超时效果起到了控制运行周期的作用(与系统延时函数相同)；当成功获得信号量(或消息)时，可以及时退出循环，终止周期性任务。</li>
<li>当采样对象是一个低频信号时，采样频率可以设置得比较低，即采样周期比系统节拍周期长得多，将采样周期设置为系统节拍的整数倍，就可以用系统提供的延时函数来控制采样周期。这样，采样功能就可以由一个独立的采样任务来完成，而不需要<code>ISR</code>配合；当采样周期与系统节拍在同一数量级时，可以另外使用一个定时器，由定时器中断产生稳定的采样周期。</li>
<li>当某种功能的运行周期与系统节拍相同时，使用系统节拍函数的钩子函数来完成此项功能是非常有利的。<code>系统节拍钩子函数</code>是系统节拍函数的一部分，具有<code>ISR</code>的性质，应当尽可能简洁，不允许调用任何可能使自己挂起来的系统服务函数。</li>
<li>由外部信号启动采样过程的方式称为<code>被动采样</code>。在被动采样中，启动采样的时刻是随机的，故没有采样周期的概念。</li>
<li>对于串行通信任务设计，有两种情况会使接收过程出现差错：</li>
</ol>
<ul>
<li>系统关中断的最长时间大于相邻两次串行接收中断的间隔时间，这时有可能遗漏一次中断，造成数据丢失。</li>
<li>有一个比串口中断优先级更高的<code>ISR</code>，其运行期间即时将中断打开，串口中断也不能响应；如果高优先级<code>ISR</code>的运行时间比相邻两次串行接收中断的间隔时间长，同样有可能遗漏一次中断，造成数据丢失。</li>
</ul>
<p>要想可靠地接收数据，需要满足以下条件：</p>
<ul>
<li>相邻两次串行接收中断的间隔时间必须大于系统死区时间。</li>
<li>接收缓存区的空闲时间必须足够存放在死区时间内接收到的新数据。</li>
</ul>
<p>数据发送为主动任务，没有什么风险。当一帧数据需要分若干次发送时，由于实时操作系统的介入，串行发送任务不宜采用查询的方法完成发送任务，以免浪费宝贵的<code>CPU</code>资源，最好由<code>ISR</code>和串行发送任务配合完成。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos系统基本用法/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos系统基本用法/" itemprop="url">ucos系统基本用法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T12:39:06+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;在任务中创建任务：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STARTUP_TASK_PRIO     8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STARTUP_TASK_STK_SIZE 80</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SysTick_init</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_Config ( SystemCoreClock / OS_TICKS_PER_SEC );</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"hello\r\n"</span> );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    OSTaskCreate ( TestUart, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;创建单次任务：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STARTUP_TASK_PRIO     8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STARTUP_TASK_STK_SIZE 80</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SysTick_init</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_Config ( SystemCoreClock / OS_TICKS_PER_SEC );</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> ( <span class="string">"hello\r\n"</span> );</span><br><span class="line">    OSTaskDel ( OS_PRIO_SELF );</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    OSTaskCreate ( TestUart, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在创建任务时传递参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> ( <span class="string">"I get %d\r\n"</span>, * ( u8 * ) p_arg );</span><br><span class="line">    OSTaskDel ( OS_PRIO_SELF );</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 i = <span class="number">100</span>;</span><br><span class="line">    OSTaskCreate ( TestUart, ( <span class="keyword">void</span> * ) &amp;i, &amp;task_testluart[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;使用信号量触发任务：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line">OS_EVENT *Sem = <span class="literal">NULL</span>; <span class="comment">/* 定义信号量指针 */</span></span><br><span class="line">u8 err = <span class="number">0</span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        OSSemPend ( Sem, <span class="number">0</span>, &amp;err ); <span class="comment">/* 等待信号量 */</span></span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"hello\r\n"</span> );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">        OSSemPost ( Sem ); <span class="comment">/* 向串口发送任务发出信号量 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    Sem = OSSemCreate ( <span class="number">1</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSTaskCreate ( TestUart, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;消息邮箱的基本使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">OS_EVENT *Mybox = <span class="literal">NULL</span>; <span class="comment">/* 定义邮箱指针 */</span></span><br><span class="line">u8 err = <span class="number">0</span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 get_Num;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        get_Num = * ( u8 * ) OSMboxPend ( Mybox, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"I get %d\r\n"</span>, get_Num );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 send = <span class="number">100</span>;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSMboxPost ( Mybox, ( <span class="keyword">void</span> * ) &amp;send );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    Mybox = OSMboxCreate ( <span class="literal">NULL</span> );</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSTaskCreate ( TestUart, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;邮箱广播机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart1[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart2[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line">OS_EVENT *Mybox = <span class="literal">NULL</span>; <span class="comment">/* 定义邮箱指针 */</span></span><br><span class="line">u8 err = <span class="number">0</span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart1</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 get_Num;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        get_Num = * ( u8 * ) OSMboxPend ( Mybox, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Task 1 -- I get %d\r\n"</span>, get_Num );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart2</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 get_Num;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        get_Num = * ( u8 * ) OSMboxPend ( Mybox, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Task 2 -- I get %d\r\n"</span>, get_Num );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    u8 send = <span class="number">100</span>;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> ) &#123;</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSMboxPostOpt ( Mybox, ( <span class="keyword">void</span> * ) &amp;send, OS_POST_OPT_BROADCAST ); <span class="comment">/* 向所有任务广播消息 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    Mybox = OSMboxCreate ( <span class="literal">NULL</span> );</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSTaskCreate ( TestUart1, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart1[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">    OSTaskCreate ( TestUart2, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart2[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO + <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;事件标志组(信号量集)的使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart1[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart2[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line">OS_FLAG_GRP *Sem_F = <span class="literal">NULL</span>; <span class="comment">/* 定义一个信号量集指针 */</span></span><br><span class="line">u8 err = <span class="number">0</span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart1</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        OSFlagPost ( Sem_F, ( OS_FLAGS ) <span class="number">2</span>, OS_FLAG_SET, &amp;err ); <span class="comment">/* 向信号量集发信号 */</span></span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Uart 1 is running\r\n"</span> );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart2</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        OSFlagPost ( Sem_F, ( OS_FLAGS ) <span class="number">1</span>, OS_FLAG_SET, &amp;err ); <span class="comment">/* 向信号量集发信号 */</span></span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Uart 2 is running\r\n"</span> );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        OSFlagPend ( Sem_F, ( OS_FLAGS ) <span class="number">3</span>, OS_FLAG_WAIT_SET_ALL, <span class="number">0</span>, &amp;err ); <span class="comment">/* 请求信号量集 */</span></span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    Sem_F = OSFlagCreate ( <span class="number">0</span>, &amp;err );</span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSTaskCreate ( TestUart1, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart1[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">    OSTaskCreate ( TestUart2, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart2[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO + <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;消息队列的使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> OS_STK task_testled[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart1[STARTUP_TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK task_testluart2[STARTUP_TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_MESSAGES    128</span></span><br><span class="line"><span class="keyword">void</span> *MsgGrp[N_MESSAGES]; <span class="comment">/* 定义消息指针数组 */</span></span><br><span class="line">OS_EVENT *Str_Q;</span><br><span class="line">u8 err = <span class="number">0</span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart1</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *recv = <span class="literal">NULL</span>;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        recv = OSQPend ( Str_Q, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Uart1 get %s\r\n"</span>, recv );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestUart2</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *recv = <span class="literal">NULL</span>;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        recv = OSQPend ( Str_Q, <span class="number">0</span>, &amp;err );</span><br><span class="line">        <span class="built_in">printf</span> ( <span class="string">"Uart2 get %s\r\n"</span>, recv );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">500</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestLed</span> <span class="params">( <span class="keyword">void</span> *p_arg )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *send1 = <span class="string">"send_1"</span>;</span><br><span class="line">    <span class="keyword">char</span> *send2 = <span class="string">"send_2"</span>;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        OSQPostFront ( Str_Q, send1 );</span><br><span class="line">        OSQPostFront ( Str_Q, send2 );</span><br><span class="line">        LED0 = !LED0;</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    SysTick_init();</span><br><span class="line">    LED_Init();</span><br><span class="line">    uart_init ( <span class="number">9600</span> );</span><br><span class="line">    OSInit();</span><br><span class="line">    Str_Q = OSQCreate ( &amp;MsgGrp[<span class="number">0</span>], N_MESSAGES ); <span class="comment">/* 创建消息队列 */</span></span><br><span class="line">    OSTaskCreate ( TestLed, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testled[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO - <span class="number">1</span> );</span><br><span class="line">    OSTaskCreate ( TestUart1, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart1[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO );</span><br><span class="line">    OSTaskCreate ( TestUart2, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;task_testluart2[STARTUP_TASK_STK_SIZE - <span class="number">1</span>], STARTUP_TASK_PRIO + <span class="number">1</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos系统注意事项/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos系统注意事项/" itemprop="url">ucos系统注意事项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T11:56:29+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><code>ucos</code>系统的底层一定要移植好，否则会出现信号量、消息邮箱失效等现象，甚至死机。移植好的系统要经过信号量、消息邮箱等测试，才能放心使用。</li>
<li>消息邮箱的创建函数一定要放在<code>ucos</code>系统初始化函数的后面，否则邮箱机制失效。</li>
<li>使用信号量、消息邮箱等机制时，一定要注意任务的优先级。</li>
<li>移植<code>ucos</code>系统后，要将设备驱动的延时函数用<code>ucos</code>的延时函数进行替代，设备的初始化函数放在任务中，否则会出现死机现象。</li>
<li>使用<code>ucos</code>系统时，如果出现死机现象，可以考虑调整任务的优先级。</li>
<li>如果芯片的内存足够的话，尽量把函数中的局部数组改为静态局部数组(加上<code>static</code>关键字)，这样可以避免堆栈溢出，尤其是在使用<code>ucos</code>操作系统的时候。</li>
<li>使用<code>ucos</code>系统时，如果系统中有包含<code>delay</code>的函数(例如<code>W5500</code>的硬重启函数)和<code>ucos</code>的系统时钟初始化函数，先使用包含<code>delay</code>的函数，因为<code>stm32</code>的<code>delay</code>函数也是使用了系统时钟。如果不注意顺序，会产生冲突。</li>
<li>注意，<code>ucos</code>的延时函数不要在非任务(即不是<code>Task</code>)的部分中运行。</li>
<li>在<code>ucos</code>的非任务(即不是<code>Task</code>)部分不要使用<code>printf</code>函数。在任务部分可以使用<code>printf</code>函数，但要注意<code>8</code>字节对齐。</li>
<li>在<code>ucos</code>的每一个任务(<code>Task</code>)中，必须要有一个类似于<code>OSTimeDlyHMSM</code>的函数，并且该函数必须要在任务的每一次轮询中产生作用。</li>
<li>在使用<code>ucos</code>时，不要将任务的优先级安排得太紧密，中间留一些间隔比较好。</li>
<li><code>ucos</code>系统在<code>STM32</code>上打印浮点数的时候会出现错误，最好让每一个任务的堆栈都以<code>8</code>字节对齐。</li>
<li>如果需要使用<code>ucos</code>的邮箱向多个任务发送信息，可以使用<code>OSMboxPostOpt</code>函数。</li>
</ol>
<h3 id="UCOS的printf浮点数问题"><a href="#UCOS的printf浮点数问题" class="headerlink" title="UCOS的printf浮点数问题"></a>UCOS的printf浮点数问题</h3><p>&emsp;&emsp;当使用<code>ucos</code>时，<code>printf</code>、<code>sprintf</code>打印浮点数会出现问题，但当类型是<code>int</code>或<code>short</code>时没有问题。根据网上资料，将任务堆栈设置为<code>8</code>字节对齐就可以了。当没有操作系统时，系统堆栈是<code>8</code>字节对齐的；但是当使用<code>ucos</code>时，用户任务不一定是<code>8</code>字节对齐。<br>&emsp;&emsp;如果是<code>IAR</code>编译器，通过<code>#pragma data_alignment</code>指定对齐字节数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_alignment=8</span></span><br><span class="line">OS_STK Task1_LED1_Stk[Task1_LED1_Stk_Size];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_alignment=8</span></span><br><span class="line">OS_STK Task2_backlight_Stk[Task2_backlight_Stk_Size];</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;如果使用<code>MDK</code>编译器，请在系统任务堆栈前面进行数据对齐声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__align ( <span class="number">8</span> ) <span class="keyword">static</span> OS_STK TaskStartStk[TASK_START_STK_SIZE];</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos信号量集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos信号量集/" itemprop="url">ucos信号量集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T11:48:15+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;信号量集又称<code>事件标志组</code>，代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"INCLUDES.h"</span></span></span><br><span class="line">​</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STK_SIZE 512</span></span><br><span class="line">​</span><br><span class="line"><span class="keyword">static</span> OS_STK StartTaskStk[TASK_STK_SIZE]; <span class="comment">/* 起始任务 */</span></span><br><span class="line"><span class="keyword">static</span> OS_STK MyTaskStk[TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK YouTaskStk[TASK_STK_SIZE];</span><br><span class="line"><span class="keyword">static</span> OS_STK HerTaskStk[TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="keyword">char</span> *s1 = <span class="string">"Mytask is running"</span>;</span><br><span class="line"><span class="keyword">char</span> *s2 = <span class="string">"Youtask is running"</span>;</span><br><span class="line"><span class="keyword">char</span> *s3 = <span class="string">"Hertask is running"</span>;</span><br><span class="line">​</span><br><span class="line">INT8U err; <span class="comment">/* 返回的错误信息 */</span></span><br><span class="line">INT8U y = <span class="number">0</span>; <span class="comment">/* 字符显示位置 */</span></span><br><span class="line">OS_FLAG_GRP *Sem_F; <span class="comment">/* 定义一个信号量集指针，是标志组类型。OS_FLAG_GRP类型的指针，用标志组描述信号量集 */</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HerTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    OSInit();</span><br><span class="line">    PC_DOSSaveReturn();</span><br><span class="line">    PC_VectSet ( uCOS, OSCtxSw );</span><br><span class="line">    <span class="comment">/* 创建信号量集，函数的原型为：OS_FLAG_GRP *OSFlagCreate(OS_FLAGS flags, INT8U *err) */</span></span><br><span class="line">    <span class="comment">/* 参数OS_FLAGS flags是信号的初始值，在这里指定为0，即信号初始值为0。参数“*err”是错误信息，前面已经定义了。</span></span><br><span class="line"><span class="comment">       返回值为OS_FLAG_GRP型的指针，即为创建的信号量集的标志组的指针，前面已经定义了 */</span></span><br><span class="line">    Sem_F = OSFlagCreate ( <span class="number">0</span>, &amp;err );</span><br><span class="line">    OSTaskCreate ( StartTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;StartTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">0</span> ); <span class="comment">/* 创建起始任务 */</span></span><br><span class="line">    OSStart();</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    INT16S key;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">    OS_ENTER_CRITICAL(); <span class="comment">/* 进入临界段 */</span></span><br><span class="line">    PC_VectSet ( <span class="number">0x08</span>, OSTickISR );</span><br><span class="line">    PC_SetTickRate ( OS_TICKS_PER_SEC );</span><br><span class="line">    OS_EXIT_CRITICAL(); <span class="comment">/* 退出临界段 */</span></span><br><span class="line">    OSStatInit();</span><br><span class="line">    <span class="comment">/* 在起始任务中创建三个任务 */</span></span><br><span class="line">    OSTaskCreate ( MyTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;MyTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">3</span> );</span><br><span class="line">    OSTaskCreate ( YouTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;YouTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">4</span> );</span><br><span class="line">    OSTaskCreate ( HerTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;HerTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">5</span> );</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( PC_GetKey ( &amp;key ) == TRUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( key == <span class="number">0x1B</span> ) &#123; <span class="comment">/* 如果按下ESC键，则退出UC/OS-II */</span></span><br><span class="line">                PC_DOSReturn();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR  cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        OSFlagPend ( <span class="comment">/* 请求信号量集 */</span></span><br><span class="line">            Sem_F, <span class="comment">/* 请求信号量集指针 */</span></span><br><span class="line">            <span class="comment">/* 过滤器，请求第0和第1位信号，即0011。这里是把数据3强制转化为OS_FLAGS</span></span><br><span class="line"><span class="comment">               类型的数据，因为过滤器和信号量集中的信号都是OS_FLAGS类型的数据 */</span></span><br><span class="line">            ( OS_FLAGS ) <span class="number">3</span>,</span><br><span class="line">            <span class="comment">/* “OS_FLAG_WAIT_SET_ALL + OS_FLAG_CONSUME”的意思是信号全是1时有效，</span></span><br><span class="line"><span class="comment">               参数OS_FLAG_CONSUME表示当任务等待的事件发生后，清除相应的事件标志位 */</span></span><br><span class="line">            OS_FLAG_WAIT_SET_ALL, <span class="comment">/* 只有当信号全是1时信号有效，没有加参数OS_FLAG_CONSUME，所以不会清除标志位 */</span></span><br><span class="line">            <span class="number">0</span>, <span class="comment">/* 表示等待时限，0表示无限等待 */</span></span><br><span class="line">            &amp;err <span class="comment">/* 错误信息 */</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">/* 任务MyTask在这里请求信号量集，如果请求到了信号量集，就继续运行，在下面显示信息；</span></span><br><span class="line"><span class="comment">           如果请求不到信号量集，MyTask就挂起，处于等待状态，只到请求到了信号量集才继续往下运行 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s1, DISP_BGND_BLACK + DISP_FGND_WHITE ); <span class="comment">/* 显示信息 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span> ); <span class="comment">/* 等待2s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR  cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s2, DISP_BGND_BLACK + DISP_FGND_WHITE ); <span class="comment">/* 显示信息 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span> ); <span class="comment">/* 等待8s */</span></span><br><span class="line">        OSFlagPost ( <span class="comment">/* 向信号量集发信号 */</span></span><br><span class="line">            Sem_F, <span class="comment">/* 发送信号量集的指针 */</span></span><br><span class="line">            <span class="comment">/* 选择要发送的信号，给第1位发信号，即0010。同样把2强制转化为OS_FLAGS型的数据，因为信号为OS_FLAGS型的 */</span></span><br><span class="line">            ( OS_FLAGS ) <span class="number">2</span>,</span><br><span class="line">            OS_FLAG_SET, <span class="comment">/* 信号有效的选项，信号置1。OS_FLAG_SET为置1，OS_FLAG_CLR为置0 */</span></span><br><span class="line">            &amp;err <span class="comment">/* 错误信息 */</span></span><br><span class="line">        );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span> ); <span class="comment">/* 等待2s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HerTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR  cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s3, DISP_BGND_BLACK + DISP_FGND_WHITE ); <span class="comment">/* 显示信息 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span> ); <span class="comment">/* 等待8s */</span></span><br><span class="line">        OSFlagPost ( <span class="comment">/* 向信号量集发信号 */</span></span><br><span class="line">            Sem_F,</span><br><span class="line">            ( OS_FLAGS ) <span class="number">1</span>, <span class="comment">/* 给第0位发信号，即0001，把1强制转化为OS_FLAGS型 */</span></span><br><span class="line">            OS_FLAG_SET, <span class="comment">/* 信号置1 */</span></span><br><span class="line">            &amp;err</span><br><span class="line">        );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> ); <span class="comment">/* 等待1s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos消息队列/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos消息队列/" itemprop="url">ucos消息队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T11:27:56+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"includes.h"</span></span></span><br><span class="line">​</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STK_SIZE 512</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_MESSAGES    128</span></span><br><span class="line">​</span><br><span class="line">OS_STK StartTaskStk[TASK_STK_SIZE];</span><br><span class="line">OS_STK MyTaskStk[TASK_STK_SIZE];</span><br><span class="line">OS_STK YouTaskStk[TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="keyword">char</span> *s_flag; <span class="comment">/* 该字符串指示哪个任务在运行 */</span></span><br><span class="line"><span class="keyword">char</span> *ss; <span class="comment">/* 存放接收到的消息指针 */</span></span><br><span class="line"><span class="keyword">char</span> *s100; <span class="comment">/* 存放发送消息的指针 */</span></span><br><span class="line"><span class="keyword">char</span> *s;</span><br><span class="line"><span class="keyword">char</span> *s500;</span><br><span class="line"><span class="keyword">void</span> *MsgGrp[N_MESSAGES]; <span class="comment">/* 定义消息指针数组 */</span></span><br><span class="line"><span class="comment">/* 创建消息队列，首先需要定义一个指针数组(用于存放消息邮箱)，然后把各个消息数据</span></span><br><span class="line"><span class="comment">   缓冲区的首地址存入这个数组中，最后再调用函数OSQCreate来创建消息队列 */</span></span><br><span class="line">INT8U err;</span><br><span class="line">INT8U y = <span class="number">0</span>;</span><br><span class="line">OS_EVENT *Str_Q; <span class="comment">/* 定义事件控制块指针。队列的事件控制块指针用于存放创建的消息队列的指针 */</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    OSInit();</span><br><span class="line">    PC_DOSSaveReturn();</span><br><span class="line">    PC_VectSet ( uCOS, OSCtxSw );</span><br><span class="line">    Str_Q = OSQCreate ( &amp;MsgGrp[<span class="number">0</span>], N_MESSAGES ); <span class="comment">/* 创建消息队列 */</span></span><br><span class="line">    <span class="comment">/* 函数的第一个参数“&amp;MsgGrp[0]”是“void **start”，是存放消息缓冲区指针数组的地址。</span></span><br><span class="line"><span class="comment">       它是指向指针数组的指针，可以用指针数组的首个元素的地址表示 */</span></span><br><span class="line">    <span class="comment">/* N_MESSAGES是该数组的大小，返回值是消息队列的指针。Str_Q是OS_EVENT型的指针，是事件控制块型的指针 */</span></span><br><span class="line">    OSTaskCreate ( StartTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;StartTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">0</span> );</span><br><span class="line">    OSStart();</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    INT16S key;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">    OS_ENTER_CRITICAL();</span><br><span class="line">    PC_VectSet ( <span class="number">0x08</span>, OSTickISR );</span><br><span class="line">    PC_SetTickRate ( OS_TICKS_PER_SEC );</span><br><span class="line">    OS_EXIT_CRITICAL();</span><br><span class="line">    OSStatInit();</span><br><span class="line">    OSTaskCreate ( MyTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;MyTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">3</span> );</span><br><span class="line">    OSTaskCreate ( YouTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;YouTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">4</span> );</span><br><span class="line">​</span><br><span class="line">    <span class="comment">// s = "How many strings could be geted?";</span></span><br><span class="line">    <span class="comment">// /* 发送消息，以LIFO后进先出的方式发送。第一个参数Str_Q是消息队列的指针，</span></span><br><span class="line">    <span class="comment">//    是OSQCreate的返回值，第二个参数s是消息指针 */</span></span><br><span class="line">    <span class="comment">// OSQPostFront( Str_Q, s );</span></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        s_flag = <span class="string">"The StartTask is running!"</span>;</span><br><span class="line">        PC_DispStr ( <span class="number">50</span>, ++y, s_flag, DISP_FGND_RED + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 提示哪个任务在运行 */</span></span><br><span class="line">​</span><br><span class="line">        <span class="keyword">if</span> ( OSTimeGet() &gt; <span class="number">100</span> &amp;&amp; OSTimeGet() &lt; <span class="number">500</span> ) &#123;</span><br><span class="line">            s100 = <span class="string">"The value of OSTIME is from 100 to 500 NOW!!"</span>;</span><br><span class="line">            OSQPostFront ( Str_Q, s100 ); <span class="comment">/* 发送消息，以LIFO后进先出的方式发送 */</span></span><br><span class="line">            s = <span class="string">"The string belongs to which task."</span>;</span><br><span class="line">            OSQPostFront ( Str_Q, s ); <span class="comment">/* 发送消息，以LIFO方式发送。所以如果要申请消息时，会先得到s，然后才是s100 */</span></span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">if</span> ( OSTimeGet() &gt; <span class="number">1000</span> &amp;&amp; OSTimeGet() &lt; <span class="number">1500</span> ) &#123;</span><br><span class="line">            s500 = <span class="string">"The value of OSTIME is from 1000 to 1500 NOW!!"</span>;</span><br><span class="line">            OSQPostFront ( Str_Q, s500 ); <span class="comment">/* 发送消息 */</span></span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">if</span> ( PC_GetKey ( &amp;key ) == TRUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( key == <span class="number">0x1B</span> ) &#123;</span><br><span class="line">                PC_DOSReturn();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        s_flag = <span class="string">"The MyTask is running!"</span>;</span><br><span class="line">        PC_DispStr ( <span class="number">50</span>, ++y, s_flag, DISP_FGND_RED + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 提示哪个任务在运行 */</span></span><br><span class="line">        <span class="comment">/* 请求消息队列，参数分别是：Str_Q为所请求消息队列的指针，第二个参数为等待时间 */</span></span><br><span class="line">        <span class="comment">/* 0表示无限等待，&amp;err为错误信息，返回值为队列控制块OS_Q成员OSQOut指向的消息(如果队列中有消息可用的话)，</span></span><br><span class="line"><span class="comment">           如果没有消息可用，在使调用OSQPend的任务挂起，使之处于等待状态，并引发一次任务调度。</span></span><br><span class="line"><span class="comment">           因为前面发送消息时使用的是LIFO的方式，所以此处第一次得到的消息是上面最后发送的消息 */</span></span><br><span class="line">        ss = OSQPend ( Str_Q, <span class="number">0</span>, &amp;err );</span><br><span class="line">        PC_DispStr ( <span class="number">3</span>, y, ss, DISP_FGND_BLACK + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 显示得到的消息 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">0</span>, y, <span class="string">"My"</span>, DISP_FGND_RED + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 显示是哪一个任务显示的 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        s_flag = <span class="string">"The YouTask is running!"</span>;</span><br><span class="line">        PC_DispStr ( <span class="number">50</span>, ++y, s_flag, DISP_FGND_RED + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 提示哪个任务在运行 */</span></span><br><span class="line">        ss = OSQPend ( Str_Q, <span class="number">0</span>, &amp;err ); <span class="comment">/* 请求消息队列 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">3</span>, y, ss, DISP_FGND_BLACK + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 显示得到的消息 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">0</span>, y, <span class="string">"You"</span>, DISP_FGND_RED + DISP_BGND_LIGHT_GRAY ); <span class="comment">/* 显示是哪一个任务显示的 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos内存管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos内存管理/" itemprop="url">ucos内存管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T11:22:58+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"INCLUDES.h"</span></span></span><br><span class="line">​</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STK_SIZE 512</span></span><br><span class="line">​</span><br><span class="line">OS_STK StartTaskStk[TASK_STK_SIZE];</span><br><span class="line">OS_STK MyTaskStk[TASK_STK_SIZE];</span><br><span class="line">OS_STK YouTaskStk[TASK_STK_SIZE];</span><br><span class="line">OS_STK HerTaskStk[TASK_STK_SIZE];</span><br><span class="line">​</span><br><span class="line"><span class="keyword">char</span> *s = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span> *s1 = <span class="string">"Mytask  "</span>;</span><br><span class="line"><span class="keyword">char</span> *s2 = <span class="string">"Youtask "</span>;</span><br><span class="line"><span class="keyword">char</span> *s3 = <span class="string">"Hertask "</span>;</span><br><span class="line">INT8U err; <span class="comment">/* 错误信息 */</span></span><br><span class="line">INT8U y = <span class="number">0</span>; <span class="comment">/* 字符显示位置 */</span></span><br><span class="line">INT8U Times = <span class="number">0</span>;</span><br><span class="line">OS_MEM *IntBuffer; <span class="comment">/* 定义内存控制块指针，创建一个内存分区时，返回值就是它 */</span></span><br><span class="line">INT8U IntPart[<span class="number">8</span>][<span class="number">6</span>]; <span class="comment">/* 划分一个具有8个内存块，每个内存块长度是6个字节的内存分区 */</span></span><br><span class="line">INT8U *IntBlkPtr; <span class="comment">/* 定义内存块指针(INT8U型) */</span></span><br><span class="line"><span class="comment">/* 存放内存分区的状态信息。函数OSMemQuery查询到的动态内存分区状态信息是一个</span></span><br><span class="line"><span class="comment">   SO_MEM_DATA型的数据结构。查询到的内存分区的有关信息就放在这个数据结构中 */</span></span><br><span class="line">OS_MEM_DATA MemInfo;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HerTask</span> <span class="params">( <span class="keyword">void</span> *data )</span></span>;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    OSInit();</span><br><span class="line">    PC_DOSSaveReturn();</span><br><span class="line">    PC_VectSet ( uCOS, OSCtxSw );</span><br><span class="line">    IntBuffer = OSMemCreate ( IntPart, <span class="number">8</span>, <span class="number">6</span>, &amp;err ); <span class="comment">/* 创建动态内存区 */</span></span><br><span class="line">    OSTaskCreate ( StartTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;StartTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">0</span> ); <span class="comment">/* 创建起始函数 */</span></span><br><span class="line">    OSStart();</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StartTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    INT16S key;</span><br><span class="line">    pdata = pdata;</span><br><span class="line">    OS_ENTER_CRITICAL();</span><br><span class="line">    PC_VectSet ( <span class="number">0x08</span>, OSTickISR );</span><br><span class="line">    PC_SetTickRate ( OS_TICKS_PER_SEC );</span><br><span class="line">    OS_EXIT_CRITICAL();</span><br><span class="line">    OSStatInit();</span><br><span class="line">    OSTaskCreate ( MyTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;MyTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">3</span> ); <span class="comment">/* 创建任务 */</span></span><br><span class="line">    OSTaskCreate ( YouTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;YouTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">4</span> );</span><br><span class="line">    OSTaskCreate ( HerTask, ( <span class="keyword">void</span> * ) <span class="number">0</span>, &amp;HerTaskStk[TASK_STK_SIZE - <span class="number">1</span>], <span class="number">5</span> );</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( PC_GetKey ( &amp;key ) == TRUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( key == <span class="number">0x1B</span> ) &#123; <span class="comment">/* 如果按下ESC键，则退出UC/OS-II */</span></span><br><span class="line">                PC_DOSReturn();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s1, DISP_BGND_BLACK + DISP_FGND_WHITE ); <span class="comment">/* 显示信息 */</span></span><br><span class="line">        IntBlkPtr = OSMemGet ( <span class="comment">/* 请求内存块*/</span></span><br><span class="line">                        IntBuffer, <span class="comment">/* 内存分区的指针 */</span></span><br><span class="line">                        &amp;err <span class="comment">/* 错误信息 */</span></span><br><span class="line">                    );</span><br><span class="line">        OSMemQuery ( <span class="comment">/* 查询内存控制块信息 */</span></span><br><span class="line">            IntBuffer, <span class="comment">/* 带查询内存控制块指针 */</span></span><br><span class="line">            &amp;MemInfo</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%0x"</span>, MemInfo.OSFreeList ); <span class="comment">/* 显示头指针，把得到的空闲内存块链表首地址的指针放到指针s所指的空间中 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">30</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE ); <span class="comment">/* 把空闲内存块链表首地址的指针显示出来 */</span></span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%d"</span>, MemInfo.OSNUsed ); <span class="comment">/* 显示已用的内存块数目 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">40</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">if</span> ( Times &gt;= <span class="number">5</span> ) &#123; <span class="comment">/* 运行六次后 */</span></span><br><span class="line">            OSMemPut ( <span class="comment">/* 释放内存块函数 */</span></span><br><span class="line">                IntBuffer, <span class="comment">/* 内存块所属内存分区的指针 */</span></span><br><span class="line">                IntBlkPtr <span class="comment">/* 待释放内存块指针 */</span></span><br><span class="line">                <span class="comment">/* 此次释放，只能释放最后一次申请到的内存块，前面因为IntBlkPtr被后面的给覆盖掉了，所以释放不了 */</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        Times++; <span class="comment">/* 运行次数加1 */</span></span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> ); <span class="comment">/* 等待1s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">YouTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s2, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        IntBlkPtr = OSMemGet ( <span class="comment">/* 请求内存块 */</span></span><br><span class="line">                        IntBuffer, <span class="comment">/* 内存分区的指针 */</span></span><br><span class="line">                        &amp;err <span class="comment">/* 错误信息 */</span></span><br><span class="line">                    );</span><br><span class="line">        OSMemQuery ( <span class="comment">/* 查询内存控制块信息 */</span></span><br><span class="line">            IntBuffer, <span class="comment">/* 待查询内存控制块指针 */</span></span><br><span class="line">            &amp;MemInfo</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%0x"</span>, MemInfo.OSFreeList ); <span class="comment">/* 显示头指针 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">30</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%d"</span>, MemInfo.OSNUsed ); <span class="comment">/* 显示已用的内存块数目 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">40</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        OSMemPut ( <span class="comment">/* 释放内存块 */</span></span><br><span class="line">            IntBuffer, <span class="comment">/* 内存块所属内存分区的指针 */</span></span><br><span class="line">            IntBlkPtr <span class="comment">/* 待释放内存块指针 */</span></span><br><span class="line">        );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span> ); <span class="comment">/* 等待2s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HerTask</span> <span class="params">( <span class="keyword">void</span> *pdata )</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> OS_CRITICAL_METHOD == 3</span></span><br><span class="line">    OS_CPU_SR cpu_sr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    pdata = pdata;</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">        PC_DispStr ( <span class="number">10</span>, ++y, s3, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        IntBlkPtr = OSMemGet ( <span class="comment">/* 请求内存块 */</span></span><br><span class="line">                        IntBuffer, <span class="comment">/* 内存分区的指针 */</span></span><br><span class="line">                        &amp;err <span class="comment">/* 错误信息 */</span></span><br><span class="line">                    );</span><br><span class="line">        OSMemQuery ( <span class="comment">/* 查询内存控制块信息 */</span></span><br><span class="line">            IntBuffer, <span class="comment">/* 待查询内存控制块指针 */</span></span><br><span class="line">            &amp;MemInfo );</span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%0x"</span>, MemInfo.OSFreeList ); <span class="comment">/* 显示头指针 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">30</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        <span class="built_in">sprintf</span> ( s, <span class="string">"%d"</span>, MemInfo.OSNUsed ); <span class="comment">/* 显示已用的内存块数目 */</span></span><br><span class="line">        PC_DispStr ( <span class="number">40</span>, y, s, DISP_BGND_BLACK + DISP_FGND_WHITE );</span><br><span class="line">        OSMemPut (</span><br><span class="line">            IntBuffer, <span class="comment">/*内存块所属内存分区的指针 */</span></span><br><span class="line">            IntBlkPtr <span class="comment">/* 待释放内存块指针 */</span></span><br><span class="line">        );</span><br><span class="line">        OSTimeDlyHMSM ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span> ); <span class="comment">/* 等待1s */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucos保存局部变量到任务堆栈/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucos保存局部变量到任务堆栈/" itemprop="url">ucos保存局部变量到任务堆栈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T09:49:02+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;1. 没有<code>OS</code>时，任务如何保存局部变量？<br>&emsp;&emsp;在我的知识体系里，我一直以为单片机中就只有一个栈。以<code>stm32</code>为例，在启动文件中有这么一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function">Amount of <span class="title">memory</span> <span class="params">(in bytes)</span> allocated <span class="keyword">for</span> Stack</span></span><br><span class="line"><span class="function"></span>; Tailor <span class="keyword">this</span> value to your application needs</span><br><span class="line">; &lt;h&gt; Stack Configuration</span><br><span class="line">; &lt;o&gt; Stack Size (in Bytes) &lt;0x0-0xFFFFFFFF:8&gt;</span><br><span class="line">; &lt;/h&gt;</span><br><span class="line"></span><br><span class="line">Stack_Size    EQU    <span class="number">0x00000400</span></span><br><span class="line">AREA   STACK, NOINIT, READWRITE, ALIGN=<span class="number">3</span></span><br><span class="line">Stack_Mem   SPACE   Stack_Size</span><br><span class="line">__initial_sp</span><br></pre></td></tr></table></figure>
<p>假设<code>STM32</code>的内存有<code>16KB</code>，从启动文件中可以看到，栈的大小为<code>0x400</code>，我称之为<code>系统栈</code>，系统栈的范围为<code>0x20000000</code>至<code>0x20000400</code>。在没有<code>OS</code>的应用中，<code>CPU</code>其实有两个任务，一个是<code>中断任务</code>，一个是<code>main</code>函数中的任务。当函数调用或者发生中断时，就使用系统栈保存局部变量和寄存器状态，也就是<code>SP</code>指向<code>0x20000000</code>至<code>0x20000400</code>。<br>&emsp;&emsp;2. <code>ucos</code>中如何保存局部变量？<br>&emsp;&emsp;其实有没有操作系统都一样，都把任务中的局部变量和当前的寄存器状态保存在栈中。在<code>UCOS</code>中，一个任务就分配一个栈。假设有两个任务，申请分配对应的任务栈如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 假设任务1的堆栈地址为0x20000500，那么任务1中的局部变量和寄存器状态将保存在0x20000500至0x20000580 */</span></span><br><span class="line"><span class="keyword">static</span> OS_STK Task1Stk[<span class="number">128</span>];</span><br><span class="line"><span class="comment">/* 假设任务1的堆栈地址为0x20000600，那么任务2中的局部变量和寄存器状态将保存在0x20000600至0x20000700 */</span></span><br><span class="line"><span class="keyword">static</span> OS_STK Task2Stk[<span class="number">256</span>];</span><br></pre></td></tr></table></figure>
<p>当任务<code>1</code>运行时，系统使用的栈不再是<code>0x20000000</code>至<code>0x20000400</code>，而是<code>0x20000500</code>至<code>0x20000580</code>；任务<code>2</code>运行时，系统中的栈指向<code>0x20000600</code>至<code>0x20000700</code>。那么如何切换<code>SP</code>呢？假设切换到任务<code>1</code>的<code>SP</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; 保存任务<span class="number">1</span>的SP</span><br><span class="line">LDR  R1, =Task1Stk ; 把SP存在R1中，在任务<span class="number">1</span>中R1等于<span class="number">0x20000500</span>至<span class="number">0x20000580</span></span><br><span class="line">LDR  R1, [R1]</span><br><span class="line">STR  R0, [R1] ; R0 is SP of process being switched out</span><br><span class="line"></span><br><span class="line">; 切换到任务<span class="number">1</span>的SP</span><br><span class="line">MSR  PSP, R0 ; Load PSP with <span class="keyword">new</span> process SP</span><br></pre></td></tr></table></figure>
<p>就这样，在<code>UCOS</code>中模拟系统栈，生成任务栈，局部变量在任务栈中的分配，而不在系统栈中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/ucos和ucgui/ucgui仪表盘/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/ucos和ucgui/ucgui仪表盘/" itemprop="url">ucgui仪表盘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T09:43:31+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GUI.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdlib.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line">​</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEG2RAD (3.1415926f/180) <span class="comment">/* 绘制弧度的转化 */</span></span></span><br><span class="line">​</span><br><span class="line"><span class="keyword">void</span> _DrawScale ( <span class="keyword">void</span> ) &#123;</span><br><span class="line">    <span class="keyword">int</span> XSize = LCD_GetXSize(); <span class="comment">/* 取得LCD物理尺寸，这个参数是在“lcdconf.h”里面定义 */</span></span><br><span class="line">    <span class="keyword">int</span> YSize = LCD_GetYSize();</span><br><span class="line">    <span class="keyword">int</span> XMide =  XSize / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> r1 = <span class="number">110</span>; <span class="comment">/* 定义效果图中下面的一条弧的半径 */</span></span><br><span class="line">    <span class="keyword">int</span> r2 = <span class="number">140</span>; <span class="comment">/* 定义效果图中上面的一条弧半径 */</span></span><br><span class="line">    <span class="keyword">int</span> rt = <span class="number">100</span>; <span class="comment">/* 定义效果图中刻度(数字)所在弧的半径 */</span></span><br><span class="line">    <span class="keyword">int</span> step = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">int</span> r = ( r1 + r2 ) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line">    GUI_SetPenSize ( r2 - r1 ); <span class="comment">/* 设置线型宽度为30 */</span></span><br><span class="line">    GUI_SetColor ( GUI_RED ); <span class="comment">/* 第一个扇形块填充红色 */</span></span><br><span class="line">    GUI_AA_DrawArc ( XMide, YSize, r, r, <span class="number">45</span>, <span class="number">60</span> );</span><br><span class="line">    GUI_SetColor ( GUI_GREEN ); <span class="comment">/* 第一个扇形块填充红色 */</span></span><br><span class="line">    GUI_AA_DrawArc ( XMide, YSize, r, r, <span class="number">60</span>, <span class="number">75</span> );</span><br><span class="line">    GUI_SetColor ( GUI_WHITE );</span><br><span class="line">    GUI_SetPenSize ( <span class="number">5</span> ); <span class="comment">/* 设置线性宽度为2，绘制上下两条圆弧 */</span></span><br><span class="line">    GUI_AA_DrawArc ( XMide, YSize, r1, r1, <span class="number">45</span>, <span class="number">135</span> ); <span class="comment">/* 绘制下圆弧 */</span></span><br><span class="line">    GUI_AA_DrawArc ( XMide, YSize, r2, r2, <span class="number">45</span>, <span class="number">135</span> ); <span class="comment">/* 绘制上圆弧 */</span></span><br><span class="line">​</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">45</span>; i &lt;= <span class="number">135</span>; i += step ) &#123;</span><br><span class="line">        <span class="keyword">float</span> co = <span class="built_in">cos</span> ( i * DEG2RAD );</span><br><span class="line">        <span class="keyword">float</span> si = <span class="built_in">sin</span> ( i * DEG2RAD );</span><br><span class="line">        <span class="keyword">int</span> x1 = XMide - r1 * co;</span><br><span class="line">        <span class="keyword">int</span> y1 = YSize - r1 * si;</span><br><span class="line">        <span class="keyword">int</span> x2 = XMide - ( r2 - <span class="number">1</span> ) * co;</span><br><span class="line">        <span class="keyword">int</span> y2 = YSize - ( r2 - <span class="number">1</span> ) * si;</span><br><span class="line">        <span class="keyword">int</span> xt = XMide - rt * co;</span><br><span class="line">        <span class="keyword">int</span> yt = YSize - rt * si;</span><br><span class="line">        GUI_SetColor ( GUI_WHITE );</span><br><span class="line">        <span class="comment">/* 绘制刻度线，共4个参数，x1和y1为直线起始坐标，x2和y2为直线终止坐标 */</span></span><br><span class="line">        GUI_AA_DrawLine ( x1, y1, x2, y2 );</span><br><span class="line">        GUI_SetColor ( GUI_GREEN );</span><br><span class="line">        GUI_SetFont ( &amp;GUI_Font8x8 );</span><br><span class="line">​</span><br><span class="line">        <span class="keyword">if</span> ( c &lt;= <span class="number">1</span> ) &#123;</span><br><span class="line">            GUI_DispCharAt ( <span class="string">'0'</span> + c * <span class="number">7</span>, xt - <span class="number">4</span>, yt - <span class="number">4</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            GUI_DispDecAt ( c * <span class="number">7</span>, xt - <span class="number">4</span>, yt - <span class="number">4</span>, <span class="number">2</span> );</span><br><span class="line">        &#125;</span><br><span class="line">​</span><br><span class="line">        c++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainTask</span> <span class="params">( <span class="keyword">void</span> )</span> </span>&#123;</span><br><span class="line">    GUI_Init();</span><br><span class="line">    _DrawScale();</span><br><span class="line">​</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fukangwei.gitee.io/2018/12/29/Python应用代码/定制计时器类/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="付康为">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="暴徒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/29/Python应用代码/定制计时器类/" itemprop="url">定制计时器类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-29T09:07:47+08:00">
                2018-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&emsp;&emsp;基本要求如下所示：</p>
<ul>
<li>定制一个计时器的类，<code>start</code>和<code>stop</code>方法代表启动计时和停止计时。</li>
<li>假设计时器对象<code>t1</code>，<code>print(t1)</code>和直接调用<code>t1</code>均显示结果。</li>
<li>当计时器未启动或已经停止计时，调用<code>stop</code>方法会给予温馨的提示。</li>
<li>两个计时器对象可以进行相加，例如<code>t1 + t2</code>。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time <span class="keyword">as</span> t</span><br><span class="line">​</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTimer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.unit = [<span class="string">"年"</span>, <span class="string">"月"</span>, <span class="string">"日"</span>, <span class="string">"小时"</span>, <span class="string">"分钟"</span>, <span class="string">"秒"</span>]</span><br><span class="line">        self.prompt = <span class="string">"未开始计时！"</span></span><br><span class="line">        self.lasted = []</span><br><span class="line">        self.begin = <span class="number">0</span></span><br><span class="line">        self.end = <span class="number">0</span></span><br><span class="line">​</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.prompt</span><br><span class="line">​</span><br><span class="line">    __repr__ = __str__</span><br><span class="line">​</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        prompt = <span class="string">"总共运行了"</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            result.append(self.lasted[index] + other.lasted[index])</span><br><span class="line">            <span class="keyword">if</span> result[index]:</span><br><span class="line">                prompt += (str(result[index]) + self.unit[index])</span><br><span class="line">        <span class="keyword">return</span> prompt</span><br><span class="line">​</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span>  <span class="comment"># 开始计时</span></span><br><span class="line">        self.begin = t.localtime()</span><br><span class="line">        self.prompt = <span class="string">"提示：请先调用stop()停止计时！"</span></span><br><span class="line">        print(<span class="string">"计时开始！"</span>)</span><br><span class="line">​</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span>  <span class="comment"># 停止计时</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.begin:</span><br><span class="line">            print(<span class="string">"提示：请先调用start()停止计时！"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.end = t.localtime()</span><br><span class="line">            self.__calc()</span><br><span class="line">            print(<span class="string">"计时结束！"</span>)</span><br><span class="line">​</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__calc</span><span class="params">(self)</span>:</span>  <span class="comment"># 内部方法，计算运行时间</span></span><br><span class="line">        self.lasted = []</span><br><span class="line">        self.prompt = <span class="string">"总共运行了"</span></span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            self.lasted.append(self.end[index] - self.begin[index])</span><br><span class="line">            <span class="keyword">if</span> self.lasted[index]:</span><br><span class="line">                self.prompt += str(self.lasted[index]) + self.unit[index]</span><br><span class="line">        <span class="comment"># 为下一轮计时初始化变量</span></span><br><span class="line">        self.begin = <span class="number">0</span></span><br><span class="line">        self.end = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>验证结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">t1 = MyTimer()</span><br><span class="line">t1  <span class="comment"># 结果为“未开始计时！”</span></span><br><span class="line">t1.stop()  <span class="comment"># 结果为“提示：请先调用start()停止计时！”</span></span><br><span class="line">t1.start()  <span class="comment"># 结果为“计时开始！”</span></span><br><span class="line">t1.stop()  <span class="comment"># 结果为“计时结束！”</span></span><br><span class="line">t1  <span class="comment"># 结果为“总共运行了7秒”</span></span><br><span class="line">t2 = MyTimer()</span><br><span class="line">t2.start()  <span class="comment"># 结果为“计时开始！”</span></span><br><span class="line">t2.stop()  <span class="comment"># 结果为“计时结束！”</span></span><br><span class="line">t2  <span class="comment"># 结果为“总共运行了6秒”</span></span><br><span class="line">t1 + t2  <span class="comment"># 结果为“总共运行了13秒”</span></span><br></pre></td></tr></table></figure>
<p>注意，这个程序还有个小<code>Bug</code>：有可能出现<code>总共运行了1分钟-30秒</code>，结果中出现负数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/70/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/70/">70</a><span class="page-number current">71</span><a class="page-number" href="/page/72/">72</a><span class="space">&hellip;</span><a class="page-number" href="/page/94/">94</a><a class="extend next" rel="next" href="/page/72/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">付康为</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">934</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">付康为</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
